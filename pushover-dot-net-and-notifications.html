<!doctypehtml><html lang=en><meta content="Julien Barbay"name=author><meta content="Julien Barbay"property=og:title><meta content=@y_nk name=twitter:creator><meta content=summary name=twitter:card><meta charset=utf-8><meta content="IE=edge"http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1"name=viewport><title>y_nk – pushover.net and notifications</title><link href=./style.css rel=stylesheet><link href=./favicon.svg rel=icon type=image/svg+xml><link href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.0.0/build/styles/paraiso-dark.min.css rel=stylesheet><script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.0.0/build/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><meta content="Get to know who's trying to use your VPN"name=description><meta content="Get to know who's trying to use your VPN"name=og:description><meta content=/pushover-dot-net-and-notifications.html name=og:url><body class=post><header><h1><a href=./ ><svg id=y_nk viewBox="0 0 100 65"><polygon class=bk points="10.1,0 20.3,10.1 0,10.1"></polygon><polygon class=ft points="20.3,10.1 46.2,36.1 36.1,46.2 0,10.1"></polygon><polygon class=bk points="35.6,10.1 45.8,20.3 45.8,0"></polygon><polygon class=ft points="89.9,44.3 89.9,64.6 45.8,20.3 45.8,0"></polygon><polygon class=bk points="89.9,0 79.7,10.1 100,10.1"></polygon><polygon class=ft points="79.7,10.1 75.3,14.6 85.4,24.7 100,10.1"></polygon><polygon class=bk points="100,54.4 89.9,44.3 89.9,64.6"></polygon></svg></a></h1></header><section id=main><hgroup><h2>pushover.net and notifications</h2><h6>September 6th, 2012</h6></hgroup><article><p><disclaimer>The original article has been retrieved from the internet archive machine and edited for fluidity.</disclaimer><p>Recently i’ve been trying to set up a web server at home. I've also set-up a private vpn (to access some NAS) and am a little concerned about being poked around so I was wondering if it was possible for me to be notified of any kind of harassment on my vpn port.<p>I discovered pushover, a push notification service which is free for receivers and also free for senders at with a rate limit of 7500 messages/month. It looked perfect since the android app is cheap (~1€), and i could create a personal application that would easy fit in this 7500 messages per month free plan.<h3 id=monitoring-connections>Monitoring connections</h3><p>The vpn server is running on a Linksys WRT54G router flash with a DDWRT firmware. After configured the vpn server with the highest log level possible, it was possible to monitor the log file to see if a new connection was made with some shell.<pre><code>$ tail /var/log/messages

Sep  6 04:43:57 router daemon.info [21643]: CTRL: Client XXX.XXX.XXX.XXX control connection started
Sep  6 04:43:57 router daemon.info [21643]: CTRL: Client XXX.XXX.XXX.XXX control connection finished</code></pre><p>I then used <code>awk</code> to filter out the logs, and put it in a simple loop to call pushover whenever a new line was added to the log<pre><code>tail -f /var/log/messages | awk '/CTRL: Client/ { print $9"-"$12 }' | while read -r args; do
  wget "http://129.168.0.XXX:8080/someProxyToPushover.php?arguments=vpn-$args";
done</code></pre><p>So now, anytime a new line appears into the log file, it will be monitored by <code>tail</code>, evaluated by <code>awk</code>, and if it matches, <code>wget</code> will call the webservice with the ip and the status of the connection.<h3 id=calling-pushover>Calling pushover</h3><p>Here’s a small script i first crafted. I takes the full example from pushover’s index page, with a small parser before.<pre><code>&lt;?php
  $split = explode("-", $_GET["arguments"]);
  $message = "";

  switch($split[0]) {
    case "vpn":
      $message = "Connection ".$split[1]." from ".$split[2];
      break;

    default:
      die('');
  }

  curl_setopt_array (
    $curl = curl_init(), array (
      CURLOPT_URL => "https://api.pushover.net/1/messages.json",
      CURLOPT_POSTFIELDS => array (
        "token" => "APP_SECRET",
        "user" => "USER_SECRET",
        "message" => $message,
      )
    )
  );

  curl_exec($curl);
  curl_close($curl);

  die('');
?></code></pre><p>I wanted to fancy it a little, so i decided to crawl a country-to-ip website that would display the country and the city of the ip, so i could have more infos about who’s connected. I modified the vpn case that way:<pre><code>case "vpn":
    $ip = $split[1];
    $status = $split[2];

    // i'm crawling the web incognito 8)
    $useragent = "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.6; fr; rv:1.9.2.6) Gecko/20100625 Firefox/3.6.6";

    $curl = curl_init("http://whatismyipaddress.com/ip/".$ip);
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, TRUE);
    curl_setopt($curl, CURLOPT_NOBODY, FALSE);
    curl_setopt($curl, CURLOPT_FORBID_REUSE, TRUE);
    curl_setopt($curl, CURLOPT_FOLLOWLOCATION, TRUE);
    curl_setopt($curl, CURLOPT_USERAGENT, $useragent);
    $data = curl_exec($curl);
    curl_close($curl);

    // it's a html parser lib called "simplehtmldom" (basically php's SizzleJS)
    require_once("html.php");

    $html = str_get_html($data);
    $country = $html->find("table", 1)->find("td", 0)->text();
    $city = $html->find("table", 1)->find("td", 2)->text();

    $message = "Connection ".$status." from ".$ip." (".trim($country).", ".trim($city).")";
    break;</code></pre><p>I added the shell script part is to the startup from the WebUI of DDWRT.<p>Thanks a lot to Danetag for staying late at night, helping me with testing from Vancouver :)<p>Btw, I know the regex in <code>awk</code> is not perfect since it monitors only a successfull connection from the vpn. I could also have made an <a href=http://www.delafond.org/traducmanfr/man/man8/iptables.8.html>iptables</a> rule to monitor any connection, and adapt the awk regex.<pre><code>iptables -t nat -I PREROUTING -p tcp --dport $VPNPORT -j LOG --log-prefix=VPNTICKLE</code></pre><p>It was just easier this way :)</article></section><footer><a href=./ class=!>← back</a></footer><script>const colors=["blue","cornflowerblue","darkorange","darkturquoise","deepskyblue","dodgerblue","gold","goldenrod","indigo","lightcoral","lightgreen","lightpink","lightseagreen","lightskyblue","lightslategray","limegreen","mediumaquamarine","mediumblue","mediumspringgreen","midnightblue","moccasin","navajowhite","orange","orangered","palegreen","paleturquoise","pink","rebeccapurple","royalblue","salmon","sandybrown","seagreen","skyblue","springgreen","steelblue","teal","tomato"];document.body.style.setProperty("--accent",colors[Math.floor(Math.random()*colors.length)])</script>